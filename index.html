<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#87CEEB">
    <title>MURMR</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <!-- Three.js for 3D murmuration -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- GPU Boids Position Shader -->
    <script id="fragmentShaderPosition" type="x-shader/x-fragment">
        uniform float time;
        uniform float delta;
        uniform sampler2D texturePosition;
        uniform sampler2D textureVelocity;

        void main() {
            vec2 uv = gl_FragCoord.xy / resolution.xy;
            vec4 tmpPos = texture2D( texturePosition, uv );
            vec3 position = tmpPos.xyz;
            vec3 velocity = texture2D( textureVelocity, uv ).xyz;

            float phase = tmpPos.w;
            phase = mod( ( phase + delta +
                length( velocity.xz ) * delta * 3. +
                max( velocity.y, 0.0 ) * delta * 6. ), 62.83 );

            gl_FragColor = vec4( position + velocity * delta * 15., phase );
        }
    </script>

    <!-- GPU Boids Velocity Shader -->
    <script id="fragmentShaderVelocity" type="x-shader/x-fragment">
        uniform float time;
        uniform float delta;
        uniform float separationDistance;
        uniform float alignmentDistance;
        uniform float cohesionDistance;
        uniform vec3 predator;
        uniform float deathMode;
        uniform float attractMode;
        uniform sampler2D texturePosition;
        uniform sampler2D textureVelocity;

        const float width = resolution.x;
        const float height = resolution.y;
        const float PI = 3.141592653589793;
        const float PI_2 = PI * 2.0;

        float zoneRadius = 40.0;
        float zoneRadiusSquared = 1600.0;
        float separationThresh = 0.45;
        float alignmentThresh = 0.65;

        const float UPPER_BOUNDS = BOUNDS;
        const float LOWER_BOUNDS = -UPPER_BOUNDS;
        const float SPEED_LIMIT = 9.0;

        void main() {
            zoneRadius = separationDistance + alignmentDistance + cohesionDistance;
            separationThresh = separationDistance / zoneRadius;
            alignmentThresh = ( separationDistance + alignmentDistance ) / zoneRadius;
            zoneRadiusSquared = zoneRadius * zoneRadius;

            vec2 uv = gl_FragCoord.xy / resolution.xy;
            vec3 birdPosition, birdVelocity;

            vec3 selfPosition = texture2D( texturePosition, uv ).xyz;
            vec3 selfVelocity = texture2D( textureVelocity, uv ).xyz;

            float dist;
            vec3 dir;
            float distSquared;
            float f;
            float percent;

            vec3 velocity = selfVelocity;
            float limit = SPEED_LIMIT;

            dir = predator * UPPER_BOUNDS - selfPosition;
            dir.z = 0.;
            dist = length( dir );
            distSquared = dist * dist;

            float preyRadius = 150.0;
            float preyRadiusSq = preyRadius * preyRadius;

            if ( dist < preyRadius ) {
                f = ( distSquared / preyRadiusSq - 1.0 ) * delta * 100.;
                // attractMode: 0 = repel (scare), 1 = attract (follow)
                if ( attractMode > 0.5 ) {
                    // Attract: fly toward the touch point
                    velocity += normalize( dir ) * abs(f) * 0.5;
                } else {
                    // Repel: fly away from touch point (original behavior)
                    velocity += normalize( dir ) * f;
                }
                limit += 5.0;
            }
            
            // When attracting, also pull birds from further away
            if ( attractMode > 0.5 && dist < preyRadius * 3.0 ) {
                velocity += normalize( dir ) * delta * 20.0;
            }

            // Attract to center
            dir = selfPosition;
            dist = length( dir );
            velocity -= normalize( dir ) * delta * 5.;

            for ( float y = 0.0; y < height; y++ ) {
                for ( float x = 0.0; x < width; x++ ) {
                    vec2 ref = vec2( x + 0.5, y + 0.5 ) / resolution.xy;
                    birdPosition = texture2D( texturePosition, ref ).xyz;

                    dir = birdPosition - selfPosition;
                    dist = length( dir );

                    if ( dist < 0.0001 ) continue;

                    distSquared = dist * dist;

                    if ( distSquared > zoneRadiusSquared ) continue;

                    percent = distSquared / zoneRadiusSquared;

                    if ( percent < separationThresh ) {
                        f = ( separationThresh / percent - 1.0 ) * delta;
                        velocity -= normalize( dir ) * f;
                    } else if ( percent < alignmentThresh ) {
                        float threshDelta = alignmentThresh - separationThresh;
                        float adjustedPercent = ( percent - separationThresh ) / threshDelta;
                        birdVelocity = texture2D( textureVelocity, ref ).xyz;
                        f = ( 0.5 - cos( adjustedPercent * PI_2 ) * 0.5 + 0.5 ) * delta;
                        velocity += normalize( birdVelocity ) * f;
                    } else {
                        float threshDelta = 1.0 - alignmentThresh;
                        float adjustedPercent;
                        if( threshDelta == 0. ) adjustedPercent = 1.;
                        else adjustedPercent = ( percent - alignmentThresh ) / threshDelta;
                        f = ( 0.5 - ( cos( adjustedPercent * PI_2 ) * -0.5 + 0.5 ) ) * delta;
                        velocity += normalize( dir ) * f;
                    }
                }
            }

            if ( length( velocity ) > limit ) {
                velocity = normalize( velocity ) * limit;
            }

            // Death mode: birds stop flocking and dive down fast
            if ( deathMode > 0.0 ) {
                // Strong downward dive velocity
                vec3 deathVelocity = vec3( 0.0, -50.0, 0.0 );
                // Add some random spread based on position for natural look
                deathVelocity.x = sin( selfPosition.x * 0.05 ) * 3.0;
                deathVelocity.z = cos( selfPosition.z * 0.05 ) * 3.0;
                velocity = mix( velocity, deathVelocity, deathMode );
            }

            gl_FragColor = vec4( velocity, 1.0 );
        }
    </script>

    <!-- Bird Vertex Shader -->
    <script type="x-shader/x-vertex" id="birdVS">
        attribute vec2 reference;
        attribute float birdVertex;
        attribute vec3 birdColor;

        uniform sampler2D texturePosition;
        uniform sampler2D textureVelocity;

        varying vec4 vColor;
        varying float z;

        void main() {
            vec4 tmpPos = texture2D( texturePosition, reference );
            vec3 pos = tmpPos.xyz;
            vec3 velocity = normalize(texture2D( textureVelocity, reference ).xyz);

            vec3 newPosition = position;

            if ( birdVertex == 4.0 || birdVertex == 7.0 ) {
                newPosition.y = sin( tmpPos.w ) * 5.;
            }

            newPosition = mat3( modelMatrix ) * newPosition;

            velocity.z *= -1.;
            float xz = length( velocity.xz );
            float xyz = 1.;
            float x = sqrt( 1. - velocity.y * velocity.y );

            float cosry = velocity.x / xz;
            float sinry = velocity.z / xz;

            float cosrz = x / xyz;
            float sinrz = velocity.y / xyz;

            mat3 maty = mat3(
                cosry, 0, -sinry,
                0    , 1, 0     ,
                sinry, 0, cosry
            );

            mat3 matz = mat3(
                cosrz , sinrz, 0,
                -sinrz, cosrz, 0,
                0     , 0    , 1
            );

            newPosition = maty * matz * newPosition;
            newPosition += pos;

            z = newPosition.z;
            vColor = vec4( birdColor, 1.0 );
            gl_Position = projectionMatrix * viewMatrix * vec4( newPosition, 1.0 );
        }
    </script>

    <!-- Bird Fragment Shader -->
    <script type="x-shader/x-fragment" id="birdFS">
        uniform vec3 birdColor;
        varying vec4 vColor;
        varying float z;

        void main() {
            float depth = ( 1000. - z ) / 1000.;
            gl_FragColor = vec4( birdColor, 1. );
        }
    </script>
</head>
<body>
    <!-- Main Murmuration Screen -->
    <div id="murmuration-screen" class="screen active">
        <canvas id="murmuration-canvas"></canvas>
        <div id="stats-overlay">
            <div id="bird-count">
                <span id="bird-number">1</span>
                <span class="label">birds</span>
            </div>
            <div id="time-display">
                <span id="elapsed-time">0:00:00</span>
                <span class="label">smoke-free</span>
            </div>
        </div>
        <!-- Menu toggle button -->
        <button id="menu-toggle" aria-label="Open menu">
            <span>‚Äπ</span>
        </button>
    </div>

    <!-- Logging Overlay (revealed on tap) -->
    <div id="logging-overlay" class="overlay">
        <div class="log-buttons">
            <button id="log-session-btn" class="log-btn session">
                <span class="icon">üçÉ</span>
                <span class="text">Log Session</span>
            </button>
            <button id="log-expense-btn" class="log-btn expense">
                <span class="icon">üí∏</span>
                <span class="text">Log Expense</span>
            </button>
            <button id="view-stats-btn" class="log-btn stats">
                <span class="icon">üìä</span>
                <span class="text">View Stats</span>
            </button>
        </div>
        <button id="toggle-theme-btn" class="log-btn theme">
            <span class="icon">üåë</span>
            <span class="text">Dark Mode</span>
        </button>
    </div>

    <!-- Stats Screen -->
    <div id="stats-screen" class="screen">
        <div class="stats-header">
            <h1>MURMR Stats</h1>
            <button id="close-stats" class="close-btn">√ó</button>
        </div>
        <div class="tab-container">
            <button class="tab-btn active" data-period="hourly">Hour</button>
            <button class="tab-btn" data-period="daily">Day</button>
            <button class="tab-btn" data-period="weekly">Week</button>
            <button class="tab-btn" data-period="monthly">Month</button>
            <button class="tab-btn" data-period="yearly">Year</button>
        </div>
        <div class="stats-content">
            <div class="stat-card">
                <h3>Sessions</h3>
                <div id="sessions-stat" class="stat-value">0</div>
                <div id="sessions-change" class="stat-change"></div>
            </div>
            <div class="stat-card">
                <h3>Spending</h3>
                <div id="spending-stat" class="stat-value">$0.00</div>
                <div id="spending-change" class="stat-change"></div>
            </div>
            <div class="stat-card wide">
                <h3>Longest Streak</h3>
                <div id="streak-stat" class="stat-value">0h 0m</div>
            </div>
            <div class="stat-card wide">
                <h3>Average Time Between</h3>
                <div id="average-stat" class="stat-value">--</div>
            </div>
            <div class="chart-container">
                <h3 id="chart-title">Activity</h3>
                <canvas id="stats-chart"></canvas>
            </div>
            <div class="retro-buttons">
                <button id="retro-session-btn" class="retro-btn">
                    <span class="icon">üçÉ</span>
                    <span class="text">Add Session Retroactively</span>
                </button>
                <button id="retro-expense-btn" class="retro-btn">
                    <span class="icon">üí∏</span>
                    <span class="text">Add Expense Retroactively</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="modal-overlay">
        <div id="expense-modal" class="modal">
            <h2>Log Expense</h2>
            <div class="input-group">
                <label for="expense-amount">Amount ($)</label>
                <input type="number" id="expense-amount" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="input-group">
                <label for="expense-quantity">Quantity (grams)</label>
                <input type="number" id="expense-quantity" min="0.1" step="0.1" value="1" placeholder="1">
            </div>
            <div class="input-group">
                <label for="expense-note">Note (optional)</label>
                <input type="text" id="expense-note" placeholder="Pack, vape, etc.">
            </div>
            <div class="modal-buttons">
                <button id="cancel-expense" class="modal-btn cancel">Cancel</button>
                <button id="save-expense" class="modal-btn save">Save</button>
            </div>
        </div>

        <div id="confirm-modal" class="modal">
            <h2>Log Session</h2>
            <p>This will reset your streak. Are you sure?</p>
            <div class="modal-buttons">
                <button id="cancel-session" class="modal-btn cancel">Cancel</button>
                <button id="confirm-session" class="modal-btn confirm">Yes, Log It</button>
            </div>
        </div>

        <div id="retro-session-modal" class="modal">
            <h2>Add Session Retroactively</h2>
            <div class="input-group">
                <label for="retro-session-date">Date</label>
                <input type="date" id="retro-session-date">
            </div>
            <div class="input-group">
                <label for="retro-session-time">Time</label>
                <input type="time" id="retro-session-time">
            </div>
            <div class="modal-buttons">
                <button id="cancel-retro-session" class="modal-btn cancel">Cancel</button>
                <button id="save-retro-session" class="modal-btn save">Add Session</button>
            </div>
        </div>

        <div id="retro-expense-modal" class="modal">
            <h2>Add Expense Retroactively</h2>
            <div class="input-group">
                <label for="retro-expense-date">Date</label>
                <input type="date" id="retro-expense-date">
            </div>
            <div class="input-group">
                <label for="retro-expense-time">Time</label>
                <input type="time" id="retro-expense-time">
            </div>
            <div class="input-group">
                <label for="retro-expense-amount">Amount ($)</label>
                <input type="number" id="retro-expense-amount" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="input-group">
                <label for="retro-expense-quantity">Quantity (grams)</label>
                <input type="number" id="retro-expense-quantity" min="0.1" step="0.1" value="1" placeholder="1">
            </div>
            <div class="input-group">
                <label for="retro-expense-note">Note (optional)</label>
                <input type="text" id="retro-expense-note" placeholder="Pack, vape, etc.">
            </div>
            <div class="modal-buttons">
                <button id="cancel-retro-expense" class="modal-btn cancel">Cancel</button>
                <button id="save-retro-expense" class="modal-btn save">Add Expense</button>
            </div>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/murmuration.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
